var MsgingMod={sSessionId:SESSION_ID,sDepId:DEPID,sPdbId:PDBID,sSessionPathPrefix:SESS_PATH_PREFIX,sFileSource:FILE_SOURCE,bEmbeddedView:EMBEDDED_VW,sCrrntMsgId:MSGID,sCrrntDataSetID:DEPID,sCrrntContentType:CONTENT_TYPE,iAjaxTimeout:6e4,sAdminContact:'Send comments to: <a href="mailto:rsala@rcsb.rutgers.edu">help@wwpdb-dev.rutgers.edu</a>',sInfoStyle:'<span class="ui-icon ui-icon-info fltlft"></span> ',sErrStyle:'<span class="ui-icon ui-icon-alert fltlft"></span> ',bDebug:!0,oDataTable:void 0,oFilesRfrncd:new Object,iCnt_DrawBackCalledOnCurrentTbl:0,bResetDisplay:!0,iCrrntMsgsHwm:MSGS_HWM,iCrrntNotesHwm:NOTES_HWM,sCrrntRowSlctd:"",sUseServerSidePrcssing:"false",sUseThreaded:"false",bAllowSorting:!1,sViewContext:"sentmsgs",bNewDraftContext:!1,iMsgCmpsHtMin:775,iMsgCmpsHtWthParentContent:875,iMsgDisplWdthMin:1200,iMsgDisplHtMin:800,iMsgDisplHtWthParentContent:850,iNoteCmpsHt:600,arrAvailFiles:[],arrColDisplOrderCorrHx:[5,1,3,15,14,16,17,18,8,4,7,0,2,6,9,10,11,12,13],bNotesExist:!1,URL:{WFLAUNCH:"/service/messaging/new_session/wf",DEVLAUNCH:"/service/messaging/launch",SEE_RAW_JSON_FOR_DTBL:"/service/messaging/test_see_json",DTBL_GET_TMPLT:"/service/messaging/get_dtbl_config_dtls",DTBL_AJAX_LOAD:"/service/messaging/get_dtbl_data",DTBL_DELETE_ROW:"/service/messaging/delete_row",SUBMIT_MSG:"/service/messaging/submit_msg",ARCHIVE_MSG:"/service/messaging/archive_msg",FORWARD_MSG:"/service/messaging/forward_msg",UPDATE_DRAFT_STATE:"/service/messaging/update_draft_state",MARK_MSG_READ:"/service/messaging/mark_msg_read",TAG_MSG:"/service/messaging/tag_msg",EXIT_NOT_FINISHED:"/service/messaging/exit_not_finished",EXIT_FINISHED:"/service/messaging/exit_finished",GET_MSG:"/service/messaging/get_msg",CHECK_AVAIL_FILES:"/service/messaging/check_avail_files",GET_FILES_RFRNCD:"/service/messaging/get_files_rfrncd",CHECK_GLBL_MSG_STATUS:"/service/messaging/check_global_msg_status",DISPLAY_MSG:"/service/messaging/display_msg"},LABEL:{MSG_THREAD_VIEW:"Switch to Message Thread View",STD_SORT_VIEW:"Switch to Standard Sorting View"}};function closeWndw(){if(0<navigator.appName.indexOf("Explorer")){var e=navigator.userAgent.indexOf("MSIE")+5,s=navigator.userAgent.substring(e,e+1);7<=s?window.open("","_self",""):window.opener=6==s?null:"",window.close()}else window.close()}function constrainTagChoices(){var e="",s=$("input[name='tag_msg']:checked");0<s.length&&(e=s.val()),0<e.length?($("input[name='tag_msg'][value='"+e+"']").prop("disabled",!1),$("input[name='tag_msg'][value!='"+e+"']").prop("disabled",!0)):$("#tag_msg :checkbox").each(function(){$(this).prop("disabled",!1)})}function promptForMsgTags(e){if("msgs"==MsgingMod.sCrrntContentType){$(e).hasClass("row_selected")&&$(e).hasClass("msg_read")&&($("#chckbx_unread").prop("checked",!1),"Y",$(e).hasClass("no_action_reqd")?$("#chckbx_no_action_reqd").prop("checked",!0):$("#chckbx_no_action_reqd").prop("checked",!1),$(e).hasClass("for_release")?$("#chckbx_for_release").prop("checked",!0):$("#chckbx_for_release").prop("checked",!1),$(e).hasClass("frm_annotator")?$("#checkbox_no_action_reqd").hide():$("#checkbox_no_action_reqd").show(),$("#tag_msg").dialog("open"))}}function getFilesReferenced(){return $("#hlprfrm").ajaxSubmit({url:MsgingMod.URL.GET_FILES_RFRNCD,async:!1,clearForm:!1,success:function(e){e&&(MsgingMod.oFilesRfrncd=e.files_rfrncd)}}),!1}function confirmAvailFiles(){return $("#hlprfrm").ajaxSubmit({url:MsgingMod.URL.CHECK_AVAIL_FILES,async:!1,clearForm:!1,success:function(e){e&&(MsgingMod.arrAvailFiles=e.file_list)}}),!1}function Message(){this.loadFromJson=function(e){this.message_subject=e.message_subject,this.message_id=e.message_id,this.message_text=e.message_text,this.sender=e.sender,this.timestamp=e.timestamp,this.parent_message_id=e.parent_message_id}}function clearFileUpload(e){if("all"==e)for(var s=1;s<4;s++)$("#aux-file"+s).replaceWith('<input type="file" size="50" id="aux-file'+s+'" name="aux-file'+s+'" class="c_'+MsgingMod.sDepId+' file_upload fltlft"/>');else $("#aux-file"+e).replaceWith('<input type="file" size="50" id="aux-file'+e+'" name="aux-file'+e+'" class="c_'+MsgingMod.sDepId+' file_upload fltlft"/>')}function resetTextArea(e){$("#msg_compose_body").replaceWith($("#msg_compose_body_tmplt_"+e).clone().attr("id","msg_compose_body").removeClass("displaynone"))}function composeMsg(e,s,t,o,n,i){"notes"==MsgingMod.sCrrntContentType?$("#msg_compose_body").val(""):(void 0!==i?resetTextArea(i):$("#msg_compose_body").val(""),confirmAvailFiles()),s&&void 0!==s?$("#msg_compose_parent_msg_id").val(s):$("#msg_compose_parent_msg_id").val(""),e&&void 0!==e?$("#msg_compose_subject").val(e):void 0!==i&&"vldtn"==i?$("#msg_compose_subject").val("PDB ID "+MsgingMod.sPdbId+" - Validation report and processed files are ready for your review"):void 0!==i&&"approval-expl"==i?$("#msg_compose_subject").val("Acknowledgement of Structure Approval"):void 0!==i&&"approval-impl"==i?$("#msg_compose_subject").val("Implicit Approval of Your Structure"):void 0!==i&&-1<["release-publ","release-nopubl"].indexOf(i)?$("#msg_compose_subject").val("Release of PDB ID "+MsgingMod.sPdbId):void 0!==i&&"reminder"==i?$("#msg_compose_subject").val("Still awaiting feedback for PDB ID "+MsgingMod.sPdbId):void 0!==i&&"system-unlocked"==i?$("#msg_compose_subject").val("System Unlocked"):"notes"!=MsgingMod.sCrrntContentType&&$("#msg_compose_subject").val("Communication regarding PDB ID "+MsgingMod.sPdbId),t&&void 0!==t?($("#msg_compose_parent_msg_div").show(),$("#msg_compose_parent_msg").html('<p><span class="strong">SENDER:</span> '+o+'</p><p><span class="strong">DATE/TIME:</span> '+n+"</p><p>"+t+"</p>")):($("#msg_compose_parent_msg").html(""),$("#msg_compose_parent_msg_div").hide()),"notes"==MsgingMod.sCrrntContentType?($("#msg_compose_assoc_files").hide(),$("#msg_compose_attch_aux_file").hide()):($("#msg_compose_assoc_files").show(),$("#msg_compose_attch_aux_file").show()),$("#msg_compose_dep_id").val(MsgingMod.sCrrntDataSetID),$("#msg_compose_assoc_files input:checkbox").prop("checked",!1),$("#msg_compose").dialog("open"),$("#msg_compose_body").width($("#msg_compose").width()-25),$("#msg_compose").dialog({resize:function(){$("#msg_compose_body").width($("#msg_compose").width()-25)}});for(var a=0;a<MsgingMod.arrAvailFiles.length;a++)$("#checkbox_"+MsgingMod.arrAvailFiles[a]).show();$("#msg_compose_subject").focus(),$("span.ui-dialog-title").css("color","white"),$("#msg_compose_body").scrollTop(0),clearFileUpload("all"),$("#aux-file-span2").hide(),$("#aux-file-span3").hide(),void 0!==i&&-1<["vldtn","release-publ","release-nopubl"].indexOf(i)&&$("#msg_compose_assoc_files").find("input[type=checkbox]:visible:not(.nmr)").prop("checked",!0)}function displayDraftMsg(e){MsgingMod.bNewDraftContext=!1;var s=$("td",e),t=$(s[0]).text(),o=($(s[1]).text(),$(s[2]).text(),MsgingMod.oDataTable.fnGetPosition(e)),n=MsgingMod.oDataTable.fnGetData(o).message_text,i=MsgingMod.oDataTable.fnGetData(o).message_id,a=(MsgingMod.oDataTable.fnGetData(o).ordinal_id,MsgingMod.oDataTable.fnGetData(o).parent_message_id);if($("#msg_compose_msg_id").val(i),a!=i){var r=new Message;getMsgDict(a,r),composeMsg(t,r.message_id,r.message_text,r.sender,r.timestamp,void 0)}else composeMsg(t,void 0,void 0,void 0,void 0,void 0);markMsgAsRead(i),$("#msg_compose_body").val(n.replace(/<br \/>/g,"\n"))}function getFileReferences(e){var s=[],t=[];for(var o in MsgingMod.oFilesRfrncd)if(o==e){s=MsgingMod.oFilesRfrncd[o];break}if(0<s.length)for(var n=0;n<s.length;n++){var i=s[n],a=i.relative_file_url.split("/"),r=a[a.length-1];i.file_name=r,t.push(i)}return t}function getMsgDict(o,s){return $("#hlprfrm").ajaxSubmit({url:MsgingMod.URL.GET_MSG,async:!1,clearForm:!1,dataType:"json",beforeSubmit:function(e,s,t){e.push({name:"msg_id",value:o})},success:function(e){e.msg_dict&&s.loadFromJson(e.msg_dict)}}),!1}function tagMsg(o,n,i){return $("#hlprfrm").ajaxSubmit({url:MsgingMod.URL.TAG_MSG,async:!1,clearForm:!1,beforeSubmit:function(e,s,t){e.push({name:"msg_id",value:MsgingMod.sCrrntMsgId}),e.push({name:"action_reqd",value:o}),e.push({name:"read_status",value:n}),e.push({name:"for_release",value:i})},success:function(){checkGlobalMsgStatus()}}),!1}function progressStart(){$("#loading").fadeIn("slow").spin("large","black")}function progressEnd(){$("#loading").fadeOut("fast").spin(!1)}function submitNewMsg(o){var e;e="sentmsgs"==MsgingMod.sViewContext||1==MsgingMod.bNewDraftContext?MsgingMod.URL.SUBMIT_MSG:MsgingMod.URL.UPDATE_DRAFT_STATE;var n=document.location.hostname,i=!1;return $("#msg_compose_frm").ajaxSubmit({url:e,async:!1,clearForm:!1,beforeSubmit:function(e,s,t){e.push({name:"send_status",value:o}),e.push({name:"filesource",value:MsgingMod.sFileSource}),e.push({name:"content_type",value:MsgingMod.sCrrntContentType}),e.push({name:"hostname",value:n}),e.push({name:"msgs_high_watermark",value:MsgingMod.iCrrntMsgsHwm}),e.push({name:"notes_high_watermark",value:MsgingMod.iCrrntNotesHwm})},success:function(e){if("true"==e.success){getFilesReferenced(),i=!0;try{"true"==String(e.pdbx_model_updated)?dodepuireset(document,MsgingMod.sDepId,jsonData.depui_pwd,!1):String(e.pdbx_model_updated)}catch(e){alert("Problem when application made request to have DEP UI reset.")}}else{var s="There was a problem submitting the message.",t="";1<e.append_msg.length&&(t=String(e.append_msg)),1<t.length&&(s=s+" "+t),alert(s)}}}),i}function propagateMsg(o,e,s,n,i,t){var a="archive"==t?MsgingMod.URL.ARCHIVE_MSG:MsgingMod.URL.FORWARD_MSG,r="archive"==t?$("#archive_msg_target_depid").val():$("#forward_msg_target_depid").val(),g=document.location.hostname,c="",l=getFileReferences(e);if(0<l.length)for(var d="",m=0;m<l.length;m++){var u=l[m],p=1<u.upload_file_name.length?" ("+u.upload_file_name+")":"";0<m&&(d=", "),c+=d+u.file_name+p}var _="ORIG MESSAGE SENDER: "+n+"\nORIG MESSAGE DATETIME: "+i+"\n\nORIG MESSAGE BODY:\n\n"+s+"\n\nORIG FILE REFERENCES: "+c;$("#hlprfrm").ajaxSubmit({url:a,async:!1,clearForm:!1,type:"POST",beforeSubmit:function(e,s,t){e.push({name:"send_status",value:"Y"}),e.push({name:"filesource",value:MsgingMod.sFileSource}),e.push({name:"content_type",value:MsgingMod.sCrrntContentType}),e.push({name:"hostname",value:g}),e.push({name:"subject",value:o}),e.push({name:"message",value:_}),e.push({name:"mode",value:"manual"}),e.push({name:"target_identifier",value:r}),e.push({name:"orig_sender",value:n}),e.push({name:"orig_recipient",value:"MessagingModule"}),e.push({name:"orig_date",value:i}),e.push({name:"orig_subject",value:o}),e.push({name:"orig_attachments",value:c})},success:function(e){var s=!1;if(e.success){for(property in e.success)"job"==property?"error"==e.success[property]&&(alert("An application error has occurred while executing this request."),s=!0):"false"==e.success[property]&&(alert("Problem on attempt to "+t+" message for dep ID: "+property+". Please verify that this is a valid dep ID."),s=!0);s||($("#"+t+"_msg").dialog("close"),$("#msg_body_display").dialog("close"))}}})}Array.prototype.indexOf||(Array.prototype.indexOf=function(e){for(var s=0;s<this.length;s++)if(this[s]===e)return s;return-1}),String.prototype.startsWith=function(e){return this.match("^"+e)==e},$(document).ready(function(){$(document).ajaxError(function(e,s,t,o){try{0==s.status?$(".errmsg.glblerr").html(MsgingMod.sErrStyle+"You are offline!!<br />Please Check Your Network.").show().fadeOut(4e3):404==s.status?$(".errmsg.glblerr").html(MsgingMod.sErrStyle+'Requested URL "'+t.url+'" not found.<br />').show().fadeOut(4e3):500==s.status?$(".errmsg.glblerr").html(MsgingMod.sErrStyle+"Internel Server Error.<br />").show().fadeOut(4e3):"parsererror"==e?$(".errmsg.glblerr").html(MsgingMod.sErrStyle+"Error.\nParsing JSON Request failed.<br />").show().fadeOut(4e3):"timeout"==e?$(".errmsg.glblerr").html(MsgingMod.sErrStyle+"Request Time out.<br />").show().fadeOut(4e3):$(".errmsg.glblerr").html(MsgingMod.sErrStyle+s.status+" : "+o+"<br />\n").show().fadeOut(4e3)}catch(e){$(".loading").hide();var n="There was an error while processing your request.\n";n+="Error description: "+e.description+"\n",n+="Click OK to continue.\n",alert(n)}}),$.ajax({url:"/msgmodule/js/jquery/ui/jquery-ui.custom.min.js",async:!1,dataType:"script"}),$.ajax({url:"/js/jquery/plugins/jquery.form.min.js",async:!1,dataType:"script"}),$.ajax({url:"/msgmodule/js/jquery/plugins-src/jquery.bt-0.9.7.wwpdb.min.js",async:!1,dataType:"script"}),$.ajax({url:"/msgmodule/js/depui.js",async:!1,dataType:"script"}),$.ajax({url:"/msgmodule/js/wfm.js",async:!1,dataType:"script"}),$.ajax({url:"/msgmodule/js/jquery/plugins-src/spin.js",async:!1,dataType:"script"}),$.ajax({url:"/msgmodule/js/jquery/plugins-src/jquery.spin.js",async:!1,dataType:"script"}),$("#reply").button(),$("#archive").button(),$("#close").button(),"commhstry"==MsgingMod.sCrrntContentType&&$("#msg_actions .write").hide(),$("#archive_msg").dialog({autoOpen:!1,height:400,width:400,modal:!0,buttons:{Archive:function(){var e=MsgingMod.sCrrntMsgId,s=new Message;getMsgDict(e,s),propagateMsg(s.message_subject,s.message_id,s.message_text,s.sender,s.timestamp,"archive"),closeWndw()},Cancel:function(){$("#archive_msg").dialog("close")}},close:function(){}}),$("#msg_compose").dialog({autoOpen:!1,height:$(window).height()-50,width:$(window).width()-50,modal:!0,buttons:{Send:function(){progressStart(),setTimeout(function(){1<$("#msg_compose_subject").val().length?submitNewMsg("Y")&&($("#msg_compose").dialog("close"),"sentmsgs"==MsgingMod.sViewContext?null!=window.opener&&$(".get_msgs",window.opener.document).trigger("click"):null!=window.opener&&$(".get_drafts",window.opener.document).trigger("click"),closeWndw()):alert("Please supply a message 'Subject'.");progressEnd()},1100)},"Save Draft":function(){submitNewMsg("N")&&($("#msg_compose").dialog("close"),"sentmsgs"==MsgingMod.sViewContext?null!=window.opener&&$(".get_msgs",window.opener.document).trigger("click"):null!=window.opener&&$(".get_drafts",window.opener.document).trigger("click"),closeWndw())},Cancel:function(){$("#msg_compose").dialog("close")}},close:function(){}}),$("#tag_msg").dialog({autoOpen:!1,height:200,width:300,modal:!0,buttons:{OK:function(){var e="Y",s="Y",t="N";$("#tag_msg :checkbox:checked").each(function(){value=$(this).val(),"no_action_reqd"==value&&(e="N"),"unread"==value&&(s="N"),"for_release"==value&&(t="Y")}),tagMsg(e,s,t),$("#tag_msg").dialog("close"),"msgs"==MsgingMod.sCrrntContentType?$(".get_msgs").trigger("click"):$(".get_drafts").trigger("click")},Cancel:function(){$("#tag_msg").dialog("close"),$("#context_menu").hide()}},close:function(){}}),confirmAvailFiles(),getFilesReferenced(),"notes"==MsgingMod.sCrrntContentType&&($("h2").css("color","purple"),$("h3").css("color","purple")),"commhstry"==MsgingMod.sCrrntContentType&&($("h2").css("color","blue"),$("h3").css("color","blue")),$("#reply").click(function(){var e=new Message;getMsgDict(MsgingMod.sCrrntMsgId,e),composeMsg("RE: "+e.message_subject,e.message_id,e.message_text,e.sender,e.timestamp,void 0)}),$("#archive").click(function(){$("#archive_msg_target_depid").val(MsgingMod.sDepId),$("#archive_msg").dialog("open")}),$("#close").click(function(){closeWndw()}),$(".compose").click(function(){"drafts"==MsgingMod.sViewContext?MsgingMod.bNewDraftContext=!0:MsgingMod.bNewDraftContext=!1,composeMsg(void 0,void 0,void 0,void 0,void 0,$(this).attr("id").split("_")[1])}),$(".clearfile").on("click",function(e){clearFileUpload($(this).attr("id").split("clear")[1])}),$(".addanother").on("click",function(e){var s=$(this).attr("id").split("addanother")[1];$("#aux-file-span"+(parseInt(s)+1)).show()}),$("#other-value-form").find("input").keypress(function(e){if(e.which&&13==e.which||e.keyCode&&13==e.keyCode)return $(this).parent().parent().parent().parent().find(".ui-dialog-buttonpane").find("button:first").click(),!1}),$("#select_all_file_references").on("click",function(){$("#msg_compose_assoc_files").find("input[type=checkbox]:visible").prop("checked",this.checked)}),$(".assoc_files_chckbox input[type=checkbox]").on("click",function(){this.checked||$("#select_all_file_references").prop("checked",this.checked)})});